<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LibreTV è®¤è¯è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
            line-height: 1.6;
        }
        .container {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #4CAF50;
            margin-bottom: 10px;
        }
        .diagnostic-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #555;
            border-radius: 5px;
            background: #333;
        }
        .diagnostic-section h3 {
            color: #4CAF50;
            margin-top: 0;
        }
        .status-good {
            color: #4CAF50;
        }
        .status-warning {
            color: #FF9800;
        }
        .status-error {
            color: #f44336;
        }
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .button:hover {
            background: #45a049;
        }
        .button.secondary {
            background: #2196F3;
        }
        .code {
            background: #222;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
            margin: 10px 0;
            border: 1px solid #555;
        }
        .fix-section {
            background: #0d47a1;
            border: 1px solid #2196F3;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .nav {
            text-align: center;
            margin-bottom: 20px;
        }
        .nav a {
            color: #4CAF50;
            text-decoration: none;
            margin: 0 10px;
            padding: 8px 16px;
            border: 1px solid #4CAF50;
            border-radius: 5px;
            display: inline-block;
        }
        .nav a:hover {
            background: #4CAF50;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
            <a href="index.html">ğŸ  è¿”å›é¦–é¡µ</a>
            <a href="simple-admin.html">âš™ï¸ å¯†ç ç®¡ç†</a>
            <a href="quick-fix.html">ğŸ› ï¸ è¯Šæ–­å·¥å…·</a>
        </div>

        <div class="header">
            <h1>ğŸ” è®¤è¯è¯Šæ–­å·¥å…·</h1>
            <p>è¯Šæ–­å’Œä¿®å¤è®¤è¯é—®é¢˜</p>
        </div>

        <button class="button" onclick="runFullDiagnosis()">ğŸ” å¼€å§‹å…¨é¢è¯Šæ–­</button>
        <button class="button secondary" onclick="testApiCall()">ğŸ§ª æµ‹è¯•APIè°ƒç”¨</button>

        <div id="diagnosisResults"></div>

        <div class="fix-section">
            <h3>ğŸ› ï¸ å¸¸è§é—®é¢˜ä¿®å¤æ–¹æ¡ˆ</h3>
            <div id="fixSuggestions">ç‚¹å‡»"å¼€å§‹å…¨é¢è¯Šæ–­"è·å–ä¿®å¤å»ºè®®</div>
        </div>
    </div>

    <script>
        // SHA-256å“ˆå¸Œå‡½æ•°
        async function calculateSHA256(text) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // æ£€æµ‹éƒ¨ç½²ç¯å¢ƒ
        function detectEnvironment() {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            
            if (hostname.includes('edgeone.app')) {
                return 'EdgeOne Pages';
            } else if (hostname.includes('vercel.app')) {
                return 'Vercel';
            } else if (hostname.includes('netlify.app')) {
                return 'Netlify';
            } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'Local Development';
            } else {
                return 'Custom Domain / Other';
            }
        }

        // å…¨é¢è¯Šæ–­
        async function runFullDiagnosis() {
            const results = document.getElementById('diagnosisResults');
            const fixSuggestions = document.getElementById('fixSuggestions');
            
            results.innerHTML = '<div class="diagnostic-section"><h3>ğŸ”„ è¯Šæ–­ä¸­...</h3></div>';
            
            let diagnostics = [];
            let fixes = [];
            
            // 1. ç¯å¢ƒæ£€æµ‹
            const environment = detectEnvironment();
            diagnostics.push(`<div class="diagnostic-section">
                <h3>ğŸŒ éƒ¨ç½²ç¯å¢ƒ</h3>
                <p><strong>æ£€æµ‹ç»“æœ:</strong> ${environment}</p>
                <p><strong>åŸŸå:</strong> ${window.location.hostname}</p>
                <p><strong>åè®®:</strong> ${window.location.protocol}</p>
            </div>`);

            // 2. é…ç½®æ–‡ä»¶æ£€æµ‹
            let configStatus = '';
            let currentPassword = '';
            try {
                // ç­‰å¾…é…ç½®åŠ è½½
                let retryCount = 0;
                while ((!window.MASTER_CONFIG || !window.MASTER_CONFIG.auth) && retryCount < 5) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    retryCount++;
                }
                
                if (window.MASTER_CONFIG && window.MASTER_CONFIG.auth) {
                    currentPassword = window.MASTER_CONFIG.auth.password;
                    const hash = await calculateSHA256(currentPassword);
                    configStatus = `<span class="status-good">âœ… é…ç½®æ­£å¸¸</span>
                    <div class="code">å½“å‰å¯†ç : ${currentPassword}
å¯†ç å“ˆå¸Œ: ${hash}</div>`;
                } else {
                    configStatus = '<span class="status-error">âŒ é…ç½®åŠ è½½å¤±è´¥</span>';
                    fixes.push('é…ç½®æ–‡ä»¶é—®é¢˜ï¼šè¯·æ£€æŸ¥ config/master-config.js æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®');
                }
            } catch (error) {
                configStatus = `<span class="status-error">âŒ é…ç½®æ£€æµ‹é”™è¯¯: ${error.message}</span>`;
            }
            
            diagnostics.push(`<div class="diagnostic-section">
                <h3>âš™ï¸ å‰ç«¯é…ç½®æ£€æµ‹</h3>
                <p>${configStatus}</p>
            </div>`);

            // 3. APIè°ƒç”¨æµ‹è¯•
            diagnostics.push(`<div class="diagnostic-section">
                <h3>ğŸ”Œ APIè¿æ¥æµ‹è¯•</h3>
                <p id="apiTestResult">æ­£åœ¨æµ‹è¯•...</p>
            </div>`);

            // 4. ç¯å¢ƒå˜é‡å»ºè®®
            if (environment.includes('EdgeOne') || environment.includes('Vercel') || environment.includes('Netlify')) {
                fixes.push(`<strong>${environment} ç¯å¢ƒå˜é‡è®¾ç½®ï¼š</strong><br>
                éœ€è¦åœ¨éƒ¨ç½²å¹³å°è®¾ç½®ç¯å¢ƒå˜é‡ï¼š<div class="code">PASSWORD=${currentPassword || 'admin123'}</div>
                ${getEnvironmentInstructions(environment)}`);
            }

            // 5. æœ¬åœ°å­˜å‚¨æ£€æµ‹
            const authSession = localStorage.getItem('authSession');
            const librevtAuth = localStorage.getItem('libretv_auth');
            let storageStatus = '';
            if (authSession || librevtAuth) {
                storageStatus = '<span class="status-warning">âš ï¸ å‘ç°æ—§çš„è®¤è¯ä¼šè¯</span>';
                fixes.push('æ¸…é™¤æ—§è®¤è¯ä¼šè¯ï¼š<button class="button" onclick="clearAuthSessions()">æ¸…é™¤è®¤è¯ä¼šè¯</button>');
            } else {
                storageStatus = '<span class="status-good">âœ… è®¤è¯ä¼šè¯å¹²å‡€</span>';
            }
            
            diagnostics.push(`<div class="diagnostic-section">
                <h3>ğŸ’¾ æœ¬åœ°å­˜å‚¨æ£€æµ‹</h3>
                <p>${storageStatus}</p>
            </div>`);

            results.innerHTML = diagnostics.join('');
            fixSuggestions.innerHTML = fixes.length > 0 ? fixes.join('<br><br>') : 'âœ… æœªå‘ç°éœ€è¦ä¿®å¤çš„é—®é¢˜';

            // å¼‚æ­¥è¿›è¡ŒAPIæµ‹è¯•
            setTimeout(testApiConnection, 1000);
        }

        // è·å–ç¯å¢ƒé…ç½®è¯´æ˜
        function getEnvironmentInstructions(env) {
            switch(env) {
                case 'EdgeOne Pages':
                    return '1. ç™»å½• EdgeOne Pages æ§åˆ¶å°<br>2. é€‰æ‹©ä½ çš„é¡¹ç›®<br>3. è¿›å…¥"ç¯å¢ƒå˜é‡"è®¾ç½®<br>4. æ·»åŠ  PASSWORD å˜é‡<br>5. é‡æ–°éƒ¨ç½²';
                case 'Vercel':
                    return '1. ç™»å½• Vercel æ§åˆ¶å°<br>2. é€‰æ‹©ä½ çš„é¡¹ç›®<br>3. è¿›å…¥ Settings > Environment Variables<br>4. æ·»åŠ  PASSWORD å˜é‡<br>5. é‡æ–°éƒ¨ç½²';
                case 'Netlify':
                    return '1. ç™»å½• Netlify æ§åˆ¶å°<br>2. é€‰æ‹©ä½ çš„ç«™ç‚¹<br>3. è¿›å…¥ Site settings > Environment variables<br>4. æ·»åŠ  PASSWORD å˜é‡<br>5. é‡æ–°éƒ¨ç½²';
                default:
                    return 'è¯·æ ¹æ®ä½ çš„éƒ¨ç½²å¹³å°è®¾ç½®ç›¸åº”çš„ç¯å¢ƒå˜é‡';
            }
        }

        // æµ‹è¯•APIè¿æ¥
        async function testApiConnection() {
            const testResult = document.getElementById('apiTestResult');
            
            try {
                // æ„é€ æµ‹è¯•APIè°ƒç”¨
                const testUrl = '/proxy/https%3A%2F%2Fapi.example.com%2Ftest';
                const currentPassword = window.MASTER_CONFIG?.auth?.password || 'admin123';
                const hash = await calculateSHA256(currentPassword);
                const timestamp = Date.now();
                
                const fullUrl = `${testUrl}?auth=${hash}&t=${timestamp}`;
                
                testResult.innerHTML = `æ­£åœ¨æµ‹è¯•APIè°ƒç”¨...<div class="code">æµ‹è¯•URL: ${fullUrl.substring(0, 100)}...
ä½¿ç”¨å¯†ç : ${currentPassword}
è®¡ç®—å“ˆå¸Œ: ${hash}</div>`;
                
                const response = await fetch(fullUrl);
                const responseText = await response.text();
                
                if (response.status === 401) {
                    testResult.innerHTML = `<span class="status-error">âŒ è®¤è¯å¤±è´¥ (401)</span>
                    <div class="code">å“åº”: ${responseText}</div>
                    <p><strong>å¯èƒ½åŸå› ï¼š</strong></p>
                    <ul>
                        <li>æœåŠ¡ç«¯å¯†ç ä¸å‰ç«¯å¯†ç ä¸åŒ¹é…</li>
                        <li>ç¯å¢ƒå˜é‡æœªè®¾ç½®æˆ–è®¾ç½®é”™è¯¯</li>
                        <li>ä»£ç†å‡½æ•°é…ç½®æœ‰è¯¯</li>
                    </ul>`;
                } else if (response.ok) {
                    testResult.innerHTML = '<span class="status-good">âœ… APIè°ƒç”¨æˆåŠŸ</span>';
                } else {
                    testResult.innerHTML = `<span class="status-warning">âš ï¸ å…¶ä»–é”™è¯¯ (${response.status})</span>
                    <div class="code">${responseText}</div>`;
                }
            } catch (error) {
                testResult.innerHTML = `<span class="status-error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</span>`;
            }
        }

        // å•ç‹¬çš„APIæµ‹è¯•
        async function testApiCall() {
            await testApiConnection();
        }

        // æ¸…é™¤è®¤è¯ä¼šè¯
        function clearAuthSessions() {
            localStorage.removeItem('authSession');
            localStorage.removeItem('libretv_auth');
            alert('âœ… è®¤è¯ä¼šè¯å·²æ¸…é™¤ï¼Œè¯·åˆ·æ–°é¡µé¢é‡æ–°ç™»å½•');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€è¯Šæ–­
        window.addEventListener('load', () => {
            setTimeout(runFullDiagnosis, 1000);
        });
    </script>
</body>
</html>