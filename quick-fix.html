<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LibreTV å¿«é€Ÿä¿®å¤è¯Šæ–­</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; background: #1a1a1a; color: #fff; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 5px; background: #2a2a2a; }
        .success { border-color: #4CAF50; background: #1b5e20; }
        .error { border-color: #f44336; background: #b71c1c; }
        .warning { border-color: #ff9800; background: #e65100; }
        .info { border-color: #2196F3; background: #0d47a1; }
        .code { background: #333; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; overflow-x: auto; }
        button { background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #1976D2; }
        input { padding: 8px; border: 1px solid #555; border-radius: 3px; background: #333; color: #fff; margin: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ LibreTV å¿«é€Ÿä¿®å¤è¯Šæ–­</h1>
    
    <div id="step1" class="section info">
        <h3>æ­¥éª¤1ï¼šæ£€æŸ¥é…ç½®åŠ è½½</h3>
        <button onclick="checkConfig()">æ£€æŸ¥é…ç½®</button>
        <div id="configResult"></div>
    </div>
    
    <div id="step2" class="section info">
        <h3>æ­¥éª¤2ï¼šæµ‹è¯•å¯†ç éªŒè¯</h3>
        <input type="password" id="testPassword" placeholder="è¾“å…¥å¯†ç : admin123" value="admin123">
        <button onclick="testPassword()">æµ‹è¯•å¯†ç </button>
        <div id="passwordResult"></div>
    </div>
    
    <div id="step3" class="section info">
        <h3>æ­¥éª¤3ï¼šæµ‹è¯•ä»£ç†è®¤è¯</h3>
        <button onclick="testProxyAuth()">æµ‹è¯•ä»£ç†è®¤è¯</button>
        <div id="proxyResult"></div>
    </div>
    
    <div id="step4" class="section info">
        <h3>æ­¥éª¤4ï¼šä¸€é”®ä¿®å¤</h3>
        <button onclick="quickFix()" style="background: #4CAF50;">ä¸€é”®ä¿®å¤é—®é¢˜</button>
        <div id="fixResult"></div>
    </div>
    
    <div id="step5" class="section info">
        <h3>æ­¥éª¤5ï¼šå¯†ç ä¿®æ”¹åŠ©æ‰‹</h3>
        <input type="text" id="newPasswordInput" placeholder="è¾“å…¥æ–°å¯†ç " style="width: 200px;">
        <button onclick="testPasswordChange()" style="background: #FF9800;">ç”Ÿæˆä¿®æ”¹æŒ‡å—</button>
        <div id="passwordChangeResult"></div>
    </div>
    
    <div id="step6" class="section info">
        <h3>æ­¥éª¤6ï¼šç¯å¢ƒå˜é‡æ£€æµ‹</h3>
        <button onclick="checkEnvironment()" style="background: #9C27B0;">æ£€æµ‹éƒ¨ç½²ç¯å¢ƒ</button>
        <div id="environmentResult"></div>
    </div>

    <!-- æŒ‰æ­£ç¡®é¡ºåºåŠ è½½è„šæœ¬ -->
    <script src="config/master-config.js"></script>
    <script src="js/auth-config.js"></script>
    <script src="js/password.js"></script>
    <script src="js/proxy-auth.js"></script>

    <script>
        // ç­‰å¾…é…ç½®åŠ è½½
        setTimeout(() => {
            checkConfig();
        }, 1000);
        
        function checkConfig() {
            const result = document.getElementById('configResult');
            const section = document.getElementById('step1');
            
            const checks = [
                `MASTER_CONFIGå­˜åœ¨: ${!!window.MASTER_CONFIG}`,
                `MASTER_CONFIG_READY: ${!!window.MASTER_CONFIG_READY}`,
                `AUTH_CONFIGå­˜åœ¨: ${!!window.AUTH_CONFIG}`,
                `å¯†ç è®¾ç½®: ${window.MASTER_CONFIG?.auth?.password || 'æœªè®¾ç½®'}`,
                `å¯†ç å“ˆå¸Œ: ${window.MASTER_CONFIG?.auth?.passwordHash ? window.MASTER_CONFIG.auth.passwordHash.substring(0, 16) + '...' : 'æœªç”Ÿæˆ'}`,
                `å¯ç”¨çŠ¶æ€: ${window.AUTH_CONFIG?.enabled}`,
                `getPasswordHashå‡½æ•°: ${typeof window.getPasswordHash}`,
                `verifyPasswordå‡½æ•°: ${typeof window.verifyPassword}`,
                `ProxyAuthå¯¹è±¡: ${typeof window.ProxyAuth}`,
                `ProxyAuth.addAuthToProxyUrlå‡½æ•°: ${typeof window.ProxyAuth?.addAuthToProxyUrl}`,
                `ProxyAuth.getPasswordHashå‡½æ•°: ${typeof window.ProxyAuth?.getPasswordHash}`,
                `localStorageè®¤è¯ä¼šè¯: ${localStorage.getItem(window.AUTH_CONFIG?.localStorageKey || 'authSession') ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`,
                `ä¸»é…ç½®å¯†ç ä¸è®¾ç½®å¯†ç åŒ¹é…: ${window.MASTER_CONFIG?.auth?.password === 'acW8E!X#hX0ktRMs' ? 'æ˜¯' : 'å¦'}`
            ];
            
            const hasErrors = checks.some(check => 
                check.includes('false') || 
                check.includes('undefined') || 
                check.includes('æœªè®¾ç½®') || 
                check.includes('æœªç”Ÿæˆ') ||
                (check.includes('ä¸»é…ç½®å¯†ç ä¸è®¾ç½®å¯†ç åŒ¹é…') && check.includes('å¦'))
            );
            
            result.innerHTML = `<div class="code">${checks.join('\n')}</div>`;
            section.className = hasErrors ? 'section error' : 'section success';
            
            if (hasErrors) {
                result.innerHTML += '<p><strong>âŒ å‘ç°é…ç½®é—®é¢˜ï¼Œè¯·ç‚¹å‡»ä¸€é”®ä¿®å¤</strong></p>';
            } else {
                result.innerHTML += '<p><strong>âœ… é…ç½®æ£€æŸ¥é€šè¿‡</strong></p>';
            }
        }
        
        async function testPassword() {
            const password = document.getElementById('testPassword').value;
            const result = document.getElementById('passwordResult');
            const section = document.getElementById('step2');
            
            if (!password) {
                result.innerHTML = '<p>âŒ è¯·è¾“å…¥å¯†ç </p>';
                return;
            }
            
            try {
                // ç­‰å¾…é…ç½®å°±ç»ª
                let attempts = 0;
                while ((!window.MASTER_CONFIG || !window.MASTER_CONFIG_READY) && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (typeof window.verifyPassword === 'function') {
                    const isValid = await window.verifyPassword(password);
                    if (isValid) {
                        result.innerHTML = '<p><strong>âœ… å¯†ç éªŒè¯æˆåŠŸï¼</strong></p>';
                        section.className = 'section success';
                    } else {
                        result.innerHTML = '<p><strong>âŒ å¯†ç éªŒè¯å¤±è´¥</strong></p>';
                        section.className = 'section error';
                    }
                } else {
                    result.innerHTML = '<p><strong>âŒ verifyPasswordå‡½æ•°ä¸å­˜åœ¨</strong></p>';
                    section.className = 'section error';
                }
            } catch (error) {
                result.innerHTML = `<p><strong>âŒ éªŒè¯å‡ºé”™: ${error.message}</strong></p>`;
                section.className = 'section error';
            }
        }
        
        async function testProxyAuth() {
            const result = document.getElementById('proxyResult');
            const section = document.getElementById('step3');
            
            try {
                // æµ‹è¯•è·å–å¯†ç å“ˆå¸Œ
                if (typeof window.getPasswordHash === 'function') {
                    const hash = await window.getPasswordHash();
                    if (hash) {
                        result.innerHTML = `<p><strong>âœ… å¯†ç å“ˆå¸Œè·å–æˆåŠŸ</strong></p><div class="code">å“ˆå¸Œ: ${hash}</div>`;
                        
                        // æµ‹è¯•ä»£ç†è®¤è¯URLç”Ÿæˆ
                        if (window.ProxyAuth && typeof window.ProxyAuth.addAuthToProxyUrl === 'function') {
                            const testUrl = await window.ProxyAuth.addAuthToProxyUrl('https://example.com/api');
                            result.innerHTML += `<p><strong>âœ… ä»£ç†è®¤è¯URLç”ŸæˆæˆåŠŸ</strong></p><div class="code">URL: ${testUrl}</div>`;
                            section.className = 'section success';
                        } else {
                            result.innerHTML += '<p><strong>âŒ ProxyAuth.addAuthToProxyUrlä¸å­˜åœ¨</strong></p>';
                            section.className = 'section error';
                        }
                    } else {
                        result.innerHTML = '<p><strong>âŒ å¯†ç å“ˆå¸Œè·å–å¤±è´¥</strong></p>';
                        section.className = 'section error';
                    }
                } else {
                    result.innerHTML = '<p><strong>âŒ getPasswordHashå‡½æ•°ä¸å­˜åœ¨</strong></p>';
                    section.className = 'section error';
                }
            } catch (error) {
                result.innerHTML = `<p><strong>âŒ ä»£ç†è®¤è¯æµ‹è¯•å¤±è´¥: ${error.message}</strong></p>`;
                section.className = 'section error';
            }
        }
        
        async function quickFix() {
            const result = document.getElementById('fixResult');
            const section = document.getElementById('step4');
            
            result.innerHTML = '<p>ğŸ”§ æ­£åœ¨ä¿®å¤é—®é¢˜...</p>';
            
            try {
                // 1. æ¸…é™¤æ‰€æœ‰ç¼“å­˜å’Œå­˜å‚¨
                localStorage.clear();
                sessionStorage.clear();
                if (window.ProxyAuth && typeof window.ProxyAuth.clearAuthCache === 'function') {
                    window.ProxyAuth.clearAuthCache();
                }
                result.innerHTML += '<p>âœ… æœ¬åœ°å­˜å‚¨å’Œç¼“å­˜å·²æ¸…é™¤</p>';
                
                // 2. é‡æ–°è®¾ç½®ä¸»é…ç½®å‡†å¤‡çŠ¶æ€
                window.MASTER_CONFIG_READY = false;
                result.innerHTML += '<p>ğŸ”„ é‡ç½®é…ç½®çŠ¶æ€</p>';
                
                // 3. å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–ä¸»é…ç½®
                if (window.MASTER_CONFIG && window.MASTER_CONFIG.auth && window.MASTER_CONFIG.auth.password) {
                    try {
                        // æ‰‹åŠ¨è®¡ç®—å¯†ç å“ˆå¸Œ
                        const encoder = new TextEncoder();
                        const data = encoder.encode(window.MASTER_CONFIG.auth.password);
                        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                        const hashArray = Array.from(new Uint8Array(hashBuffer));
                        const hash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                        
                        window.MASTER_CONFIG.auth.passwordHash = hash;
                        window.MASTER_CONFIG_READY = true;
                        
                        result.innerHTML += '<p>âœ… ä¸»é…ç½®å¯†ç å“ˆå¸Œé‡æ–°ç”Ÿæˆå®Œæˆ</p>';
                        result.innerHTML += `<div class="code">å¯†ç å“ˆå¸Œ: ${hash.substring(0, 16)}...</div>`;
                        
                        // è§¦å‘é…ç½®å°±ç»ªäº‹ä»¶
                        window.dispatchEvent(new CustomEvent('masterConfigReady', { 
                            detail: { config: window.MASTER_CONFIG } 
                        }));
                        
                    } catch (hashError) {
                        result.innerHTML += `<p>âŒ å¯†ç å“ˆå¸Œç”Ÿæˆå¤±è´¥: ${hashError.message}</p>`;
                        throw hashError;
                    }
                } else {
                    throw new Error('ä¸»é…ç½®æˆ–å¯†ç æœªæ­£ç¡®è®¾ç½®');
                }
                
                // 4. ç­‰å¾…é…ç½®ç¨³å®š
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 5. éªŒè¯ä¿®å¤ç»“æœ
                const finalHash = await window.getPasswordHash();
                if (finalHash) {
                    result.innerHTML += '<p><strong>ğŸ‰ ä¿®å¤æˆåŠŸï¼ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ª</strong></p>';
                    section.className = 'section success';
                    
                    // é‡æ–°æ£€æŸ¥æ‰€æœ‰çŠ¶æ€
                    setTimeout(() => {
                        checkConfig();
                        document.getElementById('testPassword').value = 'acW8E!X#hX0ktRMs';
                        testPassword();
                        testProxyAuth();
                    }, 500);
                } else {
                    result.innerHTML += '<p><strong>âŒ ä¿®å¤æœªå®Œå…¨æˆåŠŸï¼Œå¯†ç å“ˆå¸Œä»æ— æ³•è·å–</strong></p>';
                    section.className = 'section error';
                }
                
            } catch (error) {
                result.innerHTML += `<p><strong>âŒ ä¿®å¤è¿‡ç¨‹å‡ºé”™: ${error.message}</strong></p>`;
                section.className = 'section error';
                console.error('ä¿®å¤è¿‡ç¨‹è¯¦ç»†é”™è¯¯:', error);
            }
        }
        
        // æ·»åŠ å¯†ç ä¿®æ”¹æµ‹è¯•åŠŸèƒ½
        async function testPasswordChange() {
            const newPassword = document.getElementById('newPasswordInput').value;
            if (!newPassword) {
                alert('è¯·è¾“å…¥æ–°å¯†ç ');
                return;
            }
            
            const result = document.getElementById('passwordChangeResult');
            result.innerHTML = '<p>ğŸ”„ æ­£åœ¨æµ‹è¯•æ–°å¯†ç çš„å“ˆå¸Œç”Ÿæˆ...</p>';
            
            try {
                // è®¡ç®—æ–°å¯†ç çš„å“ˆå¸Œ
                const encoder = new TextEncoder();
                const data = encoder.encode(newPassword);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const newHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                result.innerHTML = `
                    <p><strong>âœ… æ–°å¯†ç å“ˆå¸Œè®¡ç®—æˆåŠŸ</strong></p>
                    <div class="code">æ–°å¯†ç : ${newPassword}</div>
                    <div class="code">æ–°å“ˆå¸Œ: ${newHash}</div>
                    <p><strong>ğŸ“‹ ä¿®æ”¹æ­¥éª¤ï¼š</strong></p>
                    <ol>
                        <li>æ‰“å¼€ <code>config/master-config.js</code></li>
                        <li>æ‰¾åˆ°ç¬¬8è¡Œçš„ <code>password</code> å­—æ®µ</li>
                        <li>å°† <code>'admin123'</code> æ”¹ä¸º <code>'${newPassword}'</code></li>
                        <li>ä¿å­˜æ–‡ä»¶å¹¶åˆ·æ–°é¡µé¢</li>
                    </ol>
                    <p><strong>ğŸ”„ ç³»ç»Ÿä¼šè‡ªåŠ¨åŒæ­¥æ‰€æœ‰ç»„ä»¶çš„å¯†ç å“ˆå¸Œ</strong></p>
                `;
            } catch (error) {
                result.innerHTML = `<p><strong>âŒ å“ˆå¸Œè®¡ç®—å¤±è´¥: ${error.message}</strong></p>`;
            }
        }
        
        // ç¯å¢ƒæ£€æµ‹åŠŸèƒ½
        function checkEnvironment() {
            const result = document.getElementById('environmentResult');
            const section = document.getElementById('step6');
            
            result.innerHTML = '<p>ğŸ” æ­£åœ¨æ£€æµ‹éƒ¨ç½²ç¯å¢ƒ...</p>';
            
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            const currentPassword = window.MASTER_CONFIG?.auth?.password;
            
            let environmentInfo = [];
            let recommendations = [];
            
            // æ£€æµ‹éƒ¨ç½²å¹³å°
            if (hostname.includes('edgeone.app')) {
                environmentInfo.push('ğŸŒ æ£€æµ‹åˆ° EdgeOne Pages éƒ¨ç½²');
                recommendations.push('è¯·åœ¨ EdgeOne Pages æ§åˆ¶å°è®¾ç½® PASSWORD ç¯å¢ƒå˜é‡');
                recommendations.push('ç¯å¢ƒå˜é‡å€¼åº”ä¸ config/master-config.js ä¸­çš„å¯†ç ä¸€è‡´');
            } else if (hostname.includes('vercel.app')) {
                environmentInfo.push('â–² æ£€æµ‹åˆ° Vercel éƒ¨ç½²');
                recommendations.push('è¯·åœ¨ Vercel é¡¹ç›®è®¾ç½®ä¸­æ·»åŠ  PASSWORD ç¯å¢ƒå˜é‡');
            } else if (hostname.includes('netlify.app')) {
                environmentInfo.push('ğŸŸ¢ æ£€æµ‹åˆ° Netlify éƒ¨ç½²');
                recommendations.push('è¯·åœ¨ Netlify ç«™ç‚¹è®¾ç½®ä¸­æ·»åŠ  PASSWORD ç¯å¢ƒå˜é‡');
            } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
                environmentInfo.push('ğŸ’» æœ¬åœ°å¼€å‘ç¯å¢ƒ');
                recommendations.push('æœ¬åœ°ç¯å¢ƒç›´æ¥ä» config/master-config.js è¯»å–å¯†ç ');
            } else {
                environmentInfo.push('ğŸŒ è‡ªå®šä¹‰åŸŸåéƒ¨ç½²');
                recommendations.push('è¯·æ ¹æ®ä½ çš„éƒ¨ç½²å¹³å°è®¾ç½®ç›¸åº”çš„ç¯å¢ƒå˜é‡');
            }
            
            environmentInfo.push(`ğŸ”— å½“å‰åŸŸå: ${hostname}`);
            environmentInfo.push(`ğŸ”’ åè®®: ${protocol}`);
            environmentInfo.push(`ğŸ—ï¸ é…ç½®å¯†ç : ${currentPassword ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}`);
            
            result.innerHTML = `
                <div class="code">${environmentInfo.join('\n')}</div>
                <p><strong>ğŸ’¡ é…ç½®å»ºè®®ï¼š</strong></p>
                <ul>
                    ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    <li>ç¡®ä¿ç¯å¢ƒå˜é‡å¯†ç ä¸æœ¬åœ°é…ç½®æ–‡ä»¶å¯†ç ä¸€è‡´</li>
                    <li>è®¾ç½®ç¯å¢ƒå˜é‡åéœ€è¦é‡æ–°éƒ¨ç½²é¡¹ç›®</li>
                </ul>
                <p><strong>ğŸ“– è¯¦ç»†æŒ‡å—ï¼š</strong> æŸ¥çœ‹ <code>ç¯å¢ƒå˜é‡é…ç½®æŒ‡å—.md</code></p>
            `;
            
            section.className = 'section success';
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            setTimeout(checkConfig, 2000);
        });
    </script>
</body>
</html>