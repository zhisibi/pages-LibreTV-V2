<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LibreTV å¯†ç è®¾ç½®</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
            line-height: 1.6;
        }
        .container {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #4CAF50;
            margin-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #ddd;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #555;
            border-radius: 5px;
            background: #333;
            color: #fff;
            font-size: 16px;
            box-sizing: border-box;
        }
        .form-group input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-bottom: 10px;
        }
        .button:hover {
            background: #45a049;
        }
        .button.secondary {
            background: #2196F3;
        }
        .button.secondary:hover {
            background: #1976D2;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .result.success {
            background: #1b5e20;
            border: 1px solid #4CAF50;
            display: block;
        }
        .result.error {
            background: #b71c1c;
            border: 1px solid #f44336;
            display: block;
        }
        .code {
            background: #333;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
            margin: 10px 0;
        }
        .info {
            background: #0d47a1;
            border: 1px solid #2196F3;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 10px;
            background: #333;
            border: 1px solid #555;
            color: #fff;
            cursor: pointer;
            text-align: center;
        }
        .tab.active {
            background: #4CAF50;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” LibreTV å¯†ç è®¾ç½®</h1>
            <p>è®¾ç½®æ‚¨çš„è‡ªå®šä¹‰å¯†ç </p>
        </div>

        <div class="info">
            <p><strong>ğŸ“ å½“å‰é»˜è®¤å¯†ç ï¼š</strong> <code>admin123</code></p>
            <p>é¦–æ¬¡ä½¿ç”¨è¯·ç”¨é»˜è®¤å¯†ç ç™»å½•ï¼Œç„¶ååœ¨æ­¤é¡µé¢è®¾ç½®æ–°å¯†ç ã€‚</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('plaintext')">æ˜æ–‡å¯†ç </div>
            <div class="tab" onclick="showTab('hash')">å“ˆå¸Œå€¼</div>
        </div>

        <!-- æ˜æ–‡å¯†ç è®¾ç½® -->
        <div id="plaintext-tab" class="tab-content active">
            <div class="form-group">
                <label for="currentPassword">å½“å‰å¯†ç ï¼š</label>
                <input type="password" id="currentPassword" placeholder="è¾“å…¥å½“å‰å¯†ç  (é»˜è®¤: admin123)" value="admin123">
            </div>
            <div class="form-group">
                <label for="newPassword">æ–°å¯†ç ï¼š</label>
                <input type="password" id="newPassword" placeholder="è¾“å…¥æ‚¨çš„æ–°å¯†ç ">
            </div>
            <div class="form-group">
                <label for="confirmPassword">ç¡®è®¤å¯†ç ï¼š</label>
                <input type="password" id="confirmPassword" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
            </div>
            <button class="button" onclick="updatePasswordLive()">ç«‹å³æ›´æ–°å¯†ç </button>
        </div>

        <!-- å“ˆå¸Œå€¼è®¾ç½® -->
        <div id="hash-tab" class="tab-content">
            <div class="form-group">
                <label for="passwordHash">å¯†ç å“ˆå¸Œå€¼ï¼ˆSHA-256ï¼‰ï¼š</label>
                <input type="text" id="passwordHash" placeholder="è¾“å…¥ SHA-256 å“ˆå¸Œå€¼">
            </div>
            <div class="form-group">
                <label for="plaintextForHash">å¯¹åº”çš„æ˜æ–‡å¯†ç ï¼ˆç”¨äºéªŒè¯ï¼‰ï¼š</label>
                <input type="password" id="plaintextForHash" placeholder="è¾“å…¥æ˜æ–‡å¯†ç ä»¥éªŒè¯å“ˆå¸Œ">
            </div>
            <button class="button secondary" onclick="verifyAndSetHash()">éªŒè¯å¹¶è®¾ç½®</button>
        </div>

        <button class="button secondary" onclick="generateFiles()">ç”Ÿæˆé…ç½®æ–‡ä»¶</button>

        <div id="result" class="result">
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µ
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // SHA-256 å“ˆå¸Œè®¡ç®—
        async function calculateSHA256(text) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(content, isSuccess = true) {
            const result = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');
            
            resultContent.innerHTML = content;
            result.className = 'result ' + (isSuccess ? 'success' : 'error');
        }

        // å®æ—¶æ›´æ–°å¯†ç 
        async function updatePasswordLive() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!currentPassword) {
                showResult('âŒ è¯·è¾“å…¥å½“å‰å¯†ç ', false);
                return;
            }

            if (!newPassword) {
                showResult('âŒ è¯·è¾“å…¥æ–°å¯†ç ', false);
                return;
            }

            if (newPassword !== confirmPassword) {
                showResult('âŒ ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', false);
                return;
            }

            if (newPassword.length < 6) {
                showResult('âŒ å¯†ç é•¿åº¦è‡³å°‘6ä½', false);
                return;
            }

            try {
                showResult('ğŸ”„ æ­£åœ¨æ›´æ–°å¯†ç ...', true);

                // è°ƒç”¨APIæ›´æ–°å¯†ç 
                const response = await fetch('/api/update-password.mjs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'update',
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showResult(`âœ… å¯†ç æ›´æ–°æˆåŠŸï¼
                        <div class="code">
æ—§å¯†ç : ${result.oldPassword}
æ–°å¯†ç : ${result.newPassword}
æ–°å“ˆå¸Œ: ${result.newHash}
                        </div>
                        <p><strong>ğŸ“‹ æ›´æ–°çš„æ–‡ä»¶:</strong></p>
                        <ul>
                            ${result.updatedFiles.map(file => 
                                `<li>${file.file}: ${file.updated ? 'âœ… å·²æ›´æ–°' : 'â­ï¸ ' + file.reason}</li>`
                            ).join('')}
                        </ul>
                        <p><strong>ğŸ‰ å¯†ç å·²å®æ—¶æ›´æ–°ï¼Œè¯·åˆ·æ–°é¡µé¢ä½¿ç”¨æ–°å¯†ç ç™»å½•ï¼</strong></p>`, true);
                } else {
                    showResult(`âŒ æ›´æ–°å¤±è´¥: ${result.error}`, false);
                }
            } catch (error) {
                showResult(`âŒ æ›´æ–°å¤±è´¥: ${error.message}`, false);
            }
        }

        // ä»æ˜æ–‡å¯†ç è®¾ç½®ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰
        async function setPasswordFromPlaintext() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!newPassword) {
                showResult('âŒ è¯·è¾“å…¥æ–°å¯†ç ', false);
                return;
            }

            if (newPassword !== confirmPassword) {
                showResult('âŒ ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', false);
                return;
            }

            if (newPassword.length < 6) {
                showResult('âŒ å¯†ç é•¿åº¦è‡³å°‘6ä½', false);
                return;
            }

            try {
                const hash = await calculateSHA256(newPassword);
                await generateConfigFiles(newPassword, hash);
                showResult(`âœ… å¯†ç è®¾ç½®æˆåŠŸï¼<div class="code">æ–°å¯†ç : ${newPassword}\nå“ˆå¸Œå€¼: ${hash}</div>`, true);
            } catch (error) {
                showResult(`âŒ è®¾ç½®å¤±è´¥: ${error.message}`, false);
            }
        }

        // éªŒè¯å¹¶è®¾ç½®å“ˆå¸Œ
        async function verifyAndSetHash() {
            const hash = document.getElementById('passwordHash').value.trim();
            const plaintext = document.getElementById('plaintextForHash').value;

            if (!hash) {
                showResult('âŒ è¯·è¾“å…¥å“ˆå¸Œå€¼', false);
                return;
            }

            if (!/^[a-f0-9]{64}$/i.test(hash)) {
                showResult('âŒ æ— æ•ˆçš„ SHA-256 å“ˆå¸Œæ ¼å¼', false);
                return;
            }

            if (plaintext) {
                try {
                    const calculatedHash = await calculateSHA256(plaintext);
                    if (calculatedHash.toLowerCase() !== hash.toLowerCase()) {
                        showResult('âŒ æ˜æ–‡å¯†ç ä¸å“ˆå¸Œå€¼ä¸åŒ¹é…', false);
                        return;
                    }
                } catch (error) {
                    showResult(`âŒ å“ˆå¸ŒéªŒè¯å¤±è´¥: ${error.message}`, false);
                    return;
                }
            }

            try {
                await generateConfigFiles(plaintext || '[ä»å“ˆå¸Œè®¾ç½®]', hash.toLowerCase());
                showResult(`âœ… å“ˆå¸Œè®¾ç½®æˆåŠŸï¼<div class="code">å“ˆå¸Œå€¼: ${hash.toLowerCase()}</div>`, true);
            } catch (error) {
                showResult(`âŒ è®¾ç½®å¤±è´¥: ${error.message}`, false);
            }
        }

        // ç”Ÿæˆé…ç½®æ–‡ä»¶
        async function generateConfigFiles(password, hash) {
            const files = [
                {
                    name: 'config/master-config.js',
                    content: generateMasterConfig(password)
                },
                {
                    name: 'password-sync.js',
                    content: generateSyncScript(password)
                }
            ];

            let resultHTML = '<p><strong>ğŸ‰ é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆï¼</strong></p>';
            files.forEach(file => {
                resultHTML += `<p><strong>${file.name}:</strong></p><div class="code">${file.content}</div>`;
            });
            
            showResult(resultHTML, true);
        }

        // ç”Ÿæˆä¸»é…ç½®æ–‡ä»¶å†…å®¹
        function generateMasterConfig(password) {
            return `// ä¸»é…ç½®æ–‡ä»¶ - æ‰€æœ‰å¯†ç å’Œæ ¸å¿ƒé…ç½®çš„å”¯ä¸€æ¥æº
// åªéœ€è¦åœ¨è¿™é‡Œä¿®æ”¹ï¼Œå…¶ä»–æ–‡ä»¶ä¼šè‡ªåŠ¨åŒæ­¥

const MASTER_CONFIG = {
    // ğŸ” æ ¸å¿ƒè®¤è¯é…ç½®ï¼ˆåªéœ€è¦åœ¨è¿™é‡Œä¿®æ”¹ï¼‰
    auth: {
        username: 'admin',                    // ç”¨æˆ·å
        password: '${password}',            // ä¸»å¯†ç ï¼ˆå·²è‡ªå®šä¹‰ï¼‰
        enabled: true,                        // æ˜¯å¦å¯ç”¨å¯†ç ä¿æŠ¤
        sessionDuration: 90 * 24 * 60 * 60 * 1000,  // 90å¤©
        maxLoginAttempts: 5,                  // æœ€å¤§å°è¯•æ¬¡æ•°
        lockoutDuration: 30 * 60 * 1000       // é”å®šæ—¶é—´30åˆ†é’Ÿ
    },
    
    // å…¶ä»–é…ç½®ä¿æŒä¸å˜...
};`;
        }

        // ç”ŸæˆåŒæ­¥è„šæœ¬å†…å®¹
        function generateSyncScript(password) {
            return `// å¯†ç åŒæ­¥è„šæœ¬ - è‡ªåŠ¨æ›´æ–°æ‰€æœ‰æ–‡ä»¶ä¸­çš„é»˜è®¤å¯†ç 
// ä½¿ç”¨æ–¹æ³•: node password-sync.js

const fs = require('fs');
const path = require('path');

const NEW_PASSWORD = '${password}';
const OLD_PASSWORD = 'admin123';

const filesToUpdate = [
    'js/auth-config.js',
    'config/config-loader.mjs', 
    'functions/proxy/[[path]].js'
];

console.log('ğŸ”„ å¼€å§‹åŒæ­¥å¯†ç ...');

filesToUpdate.forEach(filePath => {
    try {
        const fullPath = path.join(__dirname, filePath);
        if (fs.existsSync(fullPath)) {
            let content = fs.readFileSync(fullPath, 'utf8');
            content = content.replace(new RegExp(OLD_PASSWORD, 'g'), NEW_PASSWORD);
            fs.writeFileSync(fullPath, content, 'utf8');
            console.log('âœ… å·²æ›´æ–°:', filePath);
        }
    } catch (error) {
        console.error('âŒ æ›´æ–°å¤±è´¥:', filePath, error.message);
    }
});

console.log('ğŸ‰ å¯†ç åŒæ­¥å®Œæˆï¼');`;
        }

        // ç›´æ¥ç”Ÿæˆæ–‡ä»¶æŒ‰é’®
        function generateFiles() {
            const password = document.getElementById('newPassword').value || 
                           document.getElementById('plaintextForHash').value || 
                           'admin123';
            generateConfigFiles(password, '');
        }
    </script>
</body>
</html>